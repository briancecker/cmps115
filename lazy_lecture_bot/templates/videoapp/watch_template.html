{% extends "main/base.html" %}
{% block title %}{{ post.title }} | {{ block.super }}{% endblock title %}
{% block content %}
{{block.super}}
<div class="container">
	<script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
	<div class="row">
		<div class="col-md-7">
			<video id="feature" width=640 height=360 controls>
				<source src="{{video_url}}" type="video/mp4">
				<source src="{{video_url}}" type="video/ogg">
				Your browser does not support this video tag
			</video>
			<div><h1>{{ post.title }}</h1></div>
			<div><a href="{% url 'profile' post.author %}">{{ post.author }}</a></div>
			<div>posted on {{ post.publish_date }}</div>
			<div style="overflow: auto; height: 300px;">{{ post.description }}</div>
		</div>

		<dl class="col-md-5">
			<div><h3>Transcript:</h3></div>
			<div style="overflow: auto; height: 780px">
			{% if not finished_processing %}
				<i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i>
				{{ processing_status }}...
			{% else %}
                <div class="utterance-search">
                    <form class="utterance-form" method="POST" action="/search_utterances/" style="width: 100%">
                        {% csrf_token %}
                        <input name="video-id" type="hidden" value="{{ video_id }}" />
                        <div class="form-group input-group" style="width: 100%">
                            <input name="query" type="text" class="form-control" autocomplete="off"
                                   placeholder="Type to Filter Utterances" />
                        </div>
                    </form>
                </div>
				<dl class="dl-horizontal">
					{% for transcript in transcript_data %}
						{% for utterance in transcript.utterances %}
							<div class="utterance"
                                 data-utterance-id="{{ utterance.id }}"
                                 id="utterance_{{ utterance.id }}"
                                 onclick="goToVideoTime( {{ utterance.start_time }} );"
                                 startTime="{{ utterance.start_time }}"
                                 endTime="{{ utterance.end_time }}">
								<dt>{{ utterance.start_time }} - {{ utterance.end_time }}
									<dd>{{ utterance.text }}</dd>
								</dt>
							</div>
						{% endfor %}
					{%endfor%}
				</dl>
			{% endif %}
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function() {
		var video = Popcorn('video');

		$('.utterance').each(function(index) {
			startTime = $(this).attr("startTime");
			endTime = $(this).attr("endTime");
			video.code({
				start: startTime,
				end: endTime,

				onStart: function( options ) {
          			beginLine(index);
        		},

        		onEnd: function(options) {
        			endLine();
        		}

			});
		});

		function beginLine(num) {
			var $currentLine = $(".utterance:eq("+num+")");
			$currentLine.addClass("highlight");
		}
		function endLine() {
			$(".utterance").removeClass("highlight");
		}
	});

	function goToVideoTime(start_time) {
		var video = document.getElementById("feature");
		video.currentTime = start_time;
	}

    var $utterance_form = $(".utterance-form");
    var $query_input = $utterance_form.find("input[name='query']");
    var video_id = $utterance_form.find("input[name='video-id']").val();

    $utterance_form.on("submit", function(event) {
        event.preventDefault();
    });

    $query_input.on("input", function(event) {
        event.preventDefault();
        $.ajax({
            url: "/search_utterances/",
            type: "POST",
            data : {
                "video_id": video_id,
                "query": $query_input.val(),
            },

            success: function(json) {
                var utterance_ids = new Set(json["utterance_ids"]);
                $(".utterance").each(function() {
                    console.log("utterance: " + $(this).data("utterance-id"));
                    if (!utterance_ids.has(parseInt($(this).data("utterance-id")))) {
                        // utterance is not in the searched set, hide it
                        $(this).slideUp();
                    } else {
                        // utterance is in the searched set, show it
                        $(this).slideDown();
                    }
                });
            },

            error: function(xhr, errmsg, err) {

            }
        });

    });
</script>

<style>
	.utterance {
		color: #999;
		padding-top: 10px;
		padding-bottom: 10px;
		border-top: 1px solid rgba(0,0,0,0.2);
	}

	.utterance:hover {
		cursor: pointer;
		background-color: rgb(255, 251, 204);
	}

	.highlight {
		color: black;
	}
</style>

{% endblock content %}